# AI 重構控制界面使用指南

## 功能概述

全新的簡化界面，提供三個核心控制按鈕：

### 🎮 控制按鈕

| 按鈕 | 功能 | 使用時機 |
|------|------|----------|
| **開始重構** | 啟動新的 AI 分析任務 | 專案狀態為 READY 且無執行中任務 |
| **停止串流** | 停止日誌顯示 | AI 執行中且正在顯示日誌 |
| **重新連接** | 重新連接日誌串流 | AI 執行中但日誌已停止顯示 |

---

## 界面預覽

```
┌──────────────────────────────────────────────────────┐
│ 🤖 AI 自動重構                    [執行中]           │
├──────────────────────────────────────────────────────┤
│ [▶ 開始重構]  [⏹ 停止串流]  [🔄]                     │
│                                                       │
│ ┌─ 狀態資訊 ────────────────────────────────────┐   │
│ │ Run ID:      abc-123-def                       │   │
│ │ 階段:        plan                              │   │
│ │ 迭代:        #0                                │   │
│ │ 開始時間:    2026-02-02 14:00:00              │   │
│ └────────────────────────────────────────────────┘   │
│                                                       │
│ ┌─ 即時執行日誌 ────────────────────────────────┐   │
│ │ ● 串流中                                       │   │
│ │ ┌──────────────────────────────────────────┐  │   │
│ │ │ [14:00:01] 🤖 AI 正在分析程式碼...       │  │   │
│ │ │ [14:00:02] 🔧 呼叫工具: read_file        │  │   │
│ │ │ [14:00:03] ✅ 工具執行成功               │  │   │
│ │ └──────────────────────────────────────────┘  │   │
│ └────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
```

---

## 使用流程

### 場景 1：首次啟動重構

1. **進入專案詳情頁**
   - 確保專案狀態為 `READY`

2. **點擊「開始重構」**
   - 按鈕變為「啟動中...」
   - 系統呼叫後端 API 啟動 Agent

3. **自動開始串流**
   - 日誌區域自動出現
   - 即時顯示 AI 執行過程
   - 看到不同類型的事件：
     - 🤖 AI 回應（綠色）
     - 🔧 工具呼叫（藍色）
     - ✅ 工具結果（青色）
     - 💭 思考過程（黃色）
     - 📊 狀態更新（紫色）

4. **等待完成**
   - 狀態徽章顯示「執行中」（脈動動畫）
   - 自動輪詢更新狀態（每 5 秒）
   - 完成後顯示綠色成功橫幅

---

### 場景 2：臨時停止日誌顯示

**使用情境**：日誌太多想暫時隱藏，但不想中斷 AI 執行

1. **點擊「停止串流」**
   - 日誌區域消失
   - AI 仍在背景執行
   - 按鈕變為「重新連接」

2. **繼續查看日誌**
   - 點擊「重新連接」
   - 日誌串流恢復
   - 繼續顯示最新事件

---

### 場景 3：檢查執行狀態

**使用情境**：離開頁面後回來，想確認執行狀態

1. **進入專案詳情頁**
   - 系統自動載入最新的 Agent Run
   - 如果有執行中的任務，自動顯示

2. **查看狀態資訊**
   - Run ID
   - 當前階段（plan / test / exec）
   - 迭代次數
   - 開始時間

3. **重新連接日誌**
   - 點擊「重新連接」
   - 繼續查看執行日誌

---

## 狀態說明

### 執行狀態徽章

| 狀態 | 顏色 | 說明 |
|------|------|------|
| **執行中** | 藍色（脈動） | AI 正在分析和重構 |
| **已完成** | 綠色 | 任務成功完成 |
| **失敗** | 紅色 | 執行過程出錯 |

### 按鈕狀態

| 狀態 | 顯示按鈕 | 說明 |
|------|----------|------|
| 無任務 | 開始重構 | 可以啟動新任務 |
| 執行中（顯示日誌） | 停止串流 | 可以隱藏日誌 |
| 執行中（隱藏日誌） | 重新連接 | 可以恢復日誌顯示 |
| 已完成 | 開始重構 | 可以啟動新任務 |

---

## 日誌事件類型

### 事件顏色和圖示

| 事件類型 | 圖示 | 顏色 | 說明 |
|----------|------|------|------|
| `ai_content` | 🤖 | 綠色 | AI 模型的回應內容 |
| `tool_calls` | 🔧 | 藍色 | 呼叫工具（如讀檔、寫檔） |
| `tools_execution` | ✅ | 青色 | 工具執行結果 |
| `thinking` | 💭 | 黃色 | AI 思考過程 |
| `log` | 📄 | 灰色 | 一般日誌訊息 |
| `token_usage` | 🔢 | 黃色 | Token 使用統計 |
| `response_metadata` | ℹ️ | 灰色 | 回應元數據 |

---

## 完成狀態橫幅

### ✅ 成功完成

```
┌──────────────────────────────────────────────┐
│ ✅ 重構完成！                                 │
│                                               │
│ 分析結果已生成，可在下方查看完整日誌。        │
└──────────────────────────────────────────────┘
```

### ❌ 執行失敗

```
┌──────────────────────────────────────────────┐
│ ❌ 執行失敗                                   │
│                                               │
│ Error: Unable to analyze code structure      │
└──────────────────────────────────────────────┘
```

---

## 自動化功能

### 🔄 自動輪詢

- **觸發條件**：有執行中的 Agent Run
- **頻率**：每 5 秒
- **功能**：自動更新執行狀態
- **停止時機**：Run 完成或失敗

### 📡 自動串流

- **觸發條件**：偵測到執行中的 Run
- **功能**：自動開始日誌串流
- **優點**：刷新頁面後自動恢復日誌顯示

### 📜 自動捲動

- **功能**：新日誌自動捲動到底部
- **優點**：始終顯示最新內容

---

## 技術細節

### API 呼叫

```typescript
// 啟動 Agent Run
POST /api/v1/projects/{id}/agent/run
Response: {
  "run_id": "abc-123",
  "status": "RUNNING",
  "phase": "plan",
  ...
}

// 查詢 Agent Runs
GET /api/v1/projects/{id}/agent/runs
Response: {
  "total": 5,
  "runs": [...]
}

// 串流日誌
GET /api/v1/projects/{id}/agent/runs/{run_id}/stream
Response: Server-Sent Events (SSE)
```

### 狀態流轉

```
[無任務]
   ↓ 點擊「開始重構」
[RUNNING - 顯示日誌]
   ↓ 點擊「停止串流」
[RUNNING - 隱藏日誌]
   ↓ 點擊「重新連接」
[RUNNING - 顯示日誌]
   ↓ 自動輪詢偵測完成
[DONE / FAILED]
```

---

## 常見問題

### Q: 點擊「開始重構」沒有反應？

**A:** 檢查：
1. 專案狀態是否為 `READY`
2. 是否有其他執行中的任務
3. 瀏覽器 Console 是否有錯誤
4. 後端服務是否正常運行

### Q: 日誌沒有自動更新？

**A:** 檢查：
1. 連線狀態指示器是否顯示「串流中」
2. Network 標籤是否有 `/stream` 連線
3. 是否點擊了「停止串流」

### Q: 停止串流後 AI 還在執行嗎？

**A:** 是的！「停止串流」只是隱藏日誌顯示，AI 仍在背景執行。可以隨時點擊「重新連接」恢復日誌。

### Q: 可以同時執行多個重構任務嗎？

**A:** 目前每個專案一次只能有一個執行中的任務。需要等待當前任務完成後才能啟動新任務。

### Q: 刷新頁面後日誌會消失嗎？

**A:** 不會！系統會自動偵測執行中的 Run 並恢復日誌串流。

---

## 快捷鍵（未來功能）

| 快捷鍵 | 功能 |
|--------|------|
| `Space` | 開始/停止串流 |
| `R` | 重新整理狀態 |
| `L` | 跳到日誌底部 |

---

## 修改的檔案

### 新增
- `frontend/src/components/refactor/RefactorControl.tsx` - 重構控制組件

### 修改
- `frontend/src/pages/ProjectDetailPage.tsx` - 使用新組件
- `frontend/src/services/agent.service.ts` - SSE 解析邏輯
- `frontend/src/components/agent/AgentLogStream.tsx` - 事件類型處理
- `frontend/src/types/agent.types.ts` - 事件類型定義

---

## 後續改進

### 短期（可選）

- [ ] 新增「停止執行」功能（需後端支援）
- [ ] 新增「暫停/繼續」功能（需後端支援）
- [ ] 日誌搜尋和過濾
- [ ] 下載完整日誌

### 中期

- [ ] 多任務並行支援
- [ ] 任務佇列管理
- [ ] 歷史任務回放

### 長期

- [ ] 即時協作（多人查看同一任務）
- [ ] 任務排程（定時執行）
- [ ] 自訂重構規則

---

## 總結

✅ **已實現**：
- 簡潔的三按鈕控制界面
- 即時日誌串流顯示
- 自動狀態更新和輪詢
- 結構化事件顯示
- 完成/失敗狀態提示

🎯 **使用體驗**：
- 一鍵啟動重構
- 隨時停止/恢復日誌顯示
- 刷新頁面自動恢復
- 清晰的狀態指示

🚀 **效能優化**：
- 自動輪詢避免手動刷新
- SSE 串流低延遲
- 事件顏色區分提高可讀性
