# 前端改進測試指南

## 快速啟動

### 前置條件

確認以下服務正在運行：

```bash
# 1. 檢查 Docker 服務
docker ps

# 應該看到以下容器：
# - refactor-mongodb (MongoDB)
# - refactor-api (Backend API)
# - refactor-frontend (Frontend，如果使用 Docker)

# 2. 如果使用 Docker Compose
cd devops
docker-compose ps

# 3. 如果本地開發
# 確認 MongoDB 和 Backend API 正在運行
```

### 啟動前端（本地開發模式）

```bash
cd /Users/quan/auto-refactor-agent/frontend

# 安裝依賴（如果尚未安裝）
npm install

# 啟動開發伺服器
npm run dev

# 預期輸出：
# VITE v5.x.x  ready in xxx ms
# ➜  Local:   http://localhost:5173/
# ➜  Network: use --host to expose
```

訪問：http://localhost:5173

---

## 測試步驟

### 📋 測試 1: 註冊新帳號

1. 訪問 http://localhost:5173/register
2. 填寫表單：
   - Email: `test@example.com`
   - 使用者名稱: `testuser`
   - 密碼: `test123456`
3. 點擊「註冊」
4. **預期結果**：
   - ✅ 註冊成功
   - ✅ 自動登入
   - ✅ 跳轉到專案列表頁 `/projects`

5. **測試錯誤處理**：
   - 使用相同 email 再次註冊
   - **預期結果**：顯示錯誤訊息「Email 已被使用」或類似訊息

---

### 📋 測試 2: 登入與註冊連結

1. 登出（如果已登入）
2. 訪問 http://localhost:5173/login
3. 檢查頁面底部是否有「沒有帳號？註冊」連結
4. 點擊「註冊」連結
5. **預期結果**：跳轉到 `/register` 頁面

6. 在註冊頁檢查是否有「已有帳號？登入」連結
7. 點擊「登入」連結
8. **預期結果**：跳轉回 `/login` 頁面

---

### 📋 測試 3: 建立測試專案

登入後建立一個測試專案（用於後續日誌串流測試）：

1. 點擊「建立新專案」
2. 填寫表單：
   ```
   Repository URL: https://github.com/your-username/your-repo.git
   分支: main
   初始提示: 分析這個專案的程式碼結構，並建議重構計劃
   ```
3. 點擊「建立專案」
4. **預期結果**：跳轉到專案詳情頁

5. 點擊「Provision 專案」按鈕
6. **預期結果**：
   - ✅ 狀態變為 PROVISIONING
   - ✅ 然後變為 READY
   - ✅ 顯示容器 ID

---

### 📋 測試 4: Agent 日誌串流（核心功能）

這是最重要的測試！

1. 在專案詳情頁（狀態為 READY）
2. 點擊「🚀 啟動 AI 分析」按鈕
3. **預期結果**：
   - ✅ 顯示 Agent Run 狀態卡片
   - ✅ 狀態顯示為 RUNNING
   - ✅ 出現「即時執行日誌」卡片

4. **檢查連線狀態指示器**：
   - ✅ 綠色脈動圓點
   - ✅ 文字顯示「串流中」

5. **檢查日誌事件類型**：

   觀察日誌區域，應該會看到不同類型的事件（顏色和圖示不同）：

   - 🤖 **LLM 回應**（綠色）
     ```
     [時間戳] 🤖 AI 正在分析程式碼...
     ```

   - 🔧 **工具呼叫**（藍色）
     ```
     [時間戳] 🔧 呼叫工具: read_file
     ```

   - ✅ **工具結果**（青色）
     ```
     [時間戳] ✅ 工具執行成功
     ```

   - 💭 **思考過程**（黃色）
     ```
     [時間戳] 💭 分析程式碼結構...
     ```

   - 📊 **狀態更新**（紫色）
     ```
     [時間戳] 📊 進度: 50%
     ```

6. **測試自動捲動**：
   - ✅ 日誌應該自動捲動到底部
   - ✅ 新事件出現時，視窗自動下捲

7. **測試串流控制**：
   - 點擊「停止串流」按鈕
   - **預期結果**：
     - ✅ 連線狀態變為「未連線」（灰色圓點）
     - ✅ 不再接收新日誌

   - 點擊「開始串流」按鈕
   - **預期結果**：
     - ✅ 重新連線
     - ✅ 繼續接收日誌

8. **等待執行完成**：
   - 等待 Agent Run 完成（狀態變為 DONE）
   - **預期結果**：
     - ✅ 顯示綠色完成橫幅
     - ✅ 橫幅包含：
       - ✅ 成功圖示
       - "執行完成！" 標題
       - 引導文字
       - Artifacts 路徑
       - 「下載分析結果」按鈕

9. **測試下載功能**：
   - 點擊「下載分析結果」按鈕
   - **預期結果**：
     - ✅ 下載 `plan.md` 檔案
     - ✅ 檔案包含重構計劃內容

---

### 📋 測試 5: 錯誤處理

#### 5.1 測試執行失敗橫幅

如果想測試失敗橫幅（可選）：

1. 建立一個會失敗的專案（例如：無效的 repo URL）
2. 執行 Agent Run
3. **預期結果**：
   - ✅ 顯示紅色失敗橫幅
   - ✅ 橫幅包含：
     - ❌ 失敗圖示
     - "執行失敗" 標題
     - 詳細錯誤訊息

#### 5.2 測試後端斷線

```bash
# 停止 Backend API
docker-compose -f devops/docker-compose.yml stop api
```

1. 在前端嘗試啟動 Agent Run 或串流日誌
2. **預期結果**：
   - ✅ 顯示友善的錯誤訊息
   - ✅ 頁面不會崩潰
   - ✅ 連線狀態顯示為「未連線」

```bash
# 重新啟動 Backend
docker-compose -f devops/docker-compose.yml start api
```

3. 點擊「開始串流」或重試
4. **預期結果**：
   - ✅ 串流恢復正常

---

### 📋 測試 6: 與 CLI 功能對比

這個測試確認前端和 CLI 的日誌輸出一致：

1. **在前端執行 Agent Run**：
   - 記錄 Run ID
   - 觀察日誌輸出

2. **在 CLI 執行相同操作**：
   ```bash
   cd /Users/quan/auto-refactor-agent
   python3 cli.py

   # 選擇相同的專案
   # 選擇 "View Agent Runs"
   # 選擇相同的 Run ID
   ```

3. **比較**：
   - ✅ 事件類型一致
   - ✅ 事件順序一致
   - ✅ 時間戳相近
   - ✅ 內容相同

---

## 視覺檢查清單

### 日誌串流組件

```
┌─────────────────────────────────────────────────────┐
│ 即時執行日誌                                          │
│ ● 串流中  [停止串流]                                  │
├─────────────────────────────────────────────────────┤
│ ╔═════════════════════════════════════════════════╗ │
│ ║ [12:34:56] 🤖 AI 正在分析程式碼...              ║ │
│ ║ [12:34:57] 🔧 呼叫工具: read_file               ║ │
│ ║ [12:34:58] ✅ 工具執行成功                      ║ │
│ ║ [12:34:59] 💭 分析程式碼結構...                 ║ │
│ ║ [12:35:00] 📊 進度: 50%                         ║ │
│ ╚═════════════════════════════════════════════════╝ │
└─────────────────────────────────────────────────────┘
```

### 完成橫幅

```
┌──────────────────────────────────────────────┐
│ ✅ 執行完成！                                 │
│                                               │
│ 分析結果已生成，可下載查看重構計劃。          │
│                                               │
│ 📁 Artifacts: /path/to/artifacts             │
│                                               │
│ [下載分析結果]                                │
└──────────────────────────────────────────────┘
```

### 失敗橫幅

```
┌──────────────────────────────────────────────┐
│ ❌ 執行失敗                                   │
│                                               │
│ Error: Unable to clone repository            │
└──────────────────────────────────────────────┘
```

---

## 除錯工具

### 開啟瀏覽器開發工具

```
Chrome/Edge: F12 或 Cmd+Option+I (Mac)
Firefox: F12 或 Cmd+Option+K (Mac)
```

### 檢查網路請求

1. 開啟 Network 標籤
2. 執行操作
3. 檢查以下請求：
   - `POST /api/v1/projects/{id}/agent/run` - 啟動 Agent
   - `GET /api/v1/projects/{id}/agent/runs/{run_id}/stream` - 串流日誌

### 檢查 Console 錯誤

1. 開啟 Console 標籤
2. 查看是否有紅色錯誤訊息
3. 如果有錯誤，記錄完整堆疊追蹤

### 檢查 SSE 連線

在 Network 標籤中：
1. 找到 `/stream` 請求
2. 檢查：
   - Status: 200 OK
   - Type: eventsource 或 text/event-stream
   - Headers:
     - Authorization: Bearer {token}
     - Content-Type: text/event-stream

---

## 常見問題

### Q: 日誌串流顯示「未登入」錯誤

**A:** Token 可能已過期，請重新登入。

### Q: 日誌串流沒有自動開始

**A:** 檢查：
1. `activeRunId` 是否正確設定
2. `autoStart` prop 是否為 `true`
3. Console 是否有錯誤訊息

### Q: 日誌顯示 JSON 而不是格式化文字

**A:** 這是正常的，某些事件的 `content` 或 `results` 欄位會是 JSON 物件。

### Q: 建置失敗

**A:** 執行以下命令清除並重新安裝：
```bash
cd frontend
rm -rf node_modules package-lock.json
npm install
npm run build
```

### Q: 註冊後沒有自動登入

**A:** 檢查：
1. Network 標籤中 `/auth/register` 請求是否成功（200）
2. `/auth/login` 請求是否被自動呼叫
3. Console 是否有錯誤訊息

---

## 效能基準

### 預期載入時間

- 首次載入頁面: < 3 秒
- 日誌串流連線: < 1 秒
- 事件渲染延遲: < 100ms

### 記憶體使用

- 初始載入: ~50MB
- 串流 1000 條日誌後: ~80MB
- 建議設定日誌上限以避免記憶體溢出

---

## 成功標準

所有測試通過後，你應該能：

✅ 使用前端註冊新帳號
✅ 使用前端建立和管理專案
✅ 啟動 Agent Run
✅ 即時查看結構化的 Agent 執行日誌
✅ 看到不同類型的事件（LLM、工具、思考等）
✅ 看到清晰的連線狀態指示
✅ 看到執行完成/失敗的視覺反饋
✅ 下載分析結果
✅ 前端功能與 CLI 功能完全一致

---

## 下一步

完成測試後，可以：

1. **部署到生產環境**
   ```bash
   npm run build
   # 將 dist/ 目錄部署到 Web 伺服器
   ```

2. **繼續開發其他功能**
   - 多執行追蹤
   - 日誌過濾和搜尋
   - TEST 和 EXEC phase 支援

3. **效能優化**
   - 實作虛擬滾動
   - 日誌持久化
   - 離線支援

---

## 回報問題

如果發現任何問題，請記錄：

1. **問題描述**
2. **重現步驟**
3. **預期行為**
4. **實際行為**
5. **瀏覽器 Console 錯誤訊息**
6. **Network 標籤截圖**

然後在專案 issue tracker 建立新 issue。
